<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ IPSet Whitelist + IPTables</title>
  <style>
    body {
      font-family: monospace;
      background: #f0f0f0;
      padding: 2em;
      color: #222;
    }
    h1, h2 {
      color: #333;
    }
    code, pre {
      background: #e8e8e8;
      padding: 1em;
      display: block;
      white-space: pre-wrap;
      word-break: break-word;
      border-left: 4px solid #888;
      margin-bottom: 1.5em;
    }
    .note {
      background: #fff3cd;
      padding: 1em;
      border-left: 4px solid #ffcc00;
      margin-bottom: 2em;
    }
  </style>
</head>
<body>

  <h1>üîê –ù–∞—Å—Ç—Ä–æ–π–∫–∞: IPSet Whitelist + IPTables</h1>

  <div class="note">
    <strong>–¶–µ–ª—å:</strong> –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –ø–æ—Ä—Ç—É SSH (2220) —Ç–æ–ª—å–∫–æ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö IP —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º IPSet –∏ IPTables, –∞ —Ç–∞–∫–∂–µ –æ–±–µ—Å–ø–µ—á–∏—Ç—å –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫—É –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å–∏—Å—Ç–µ–º—ã.
  </div>

  <h2>1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ ipset –∏ iptables-persistent</h2>
  <pre><code>sudo apt update
sudo apt install ipset iptables-persistent -y</code></pre>

  <h2>2. –°–æ–∑–¥–∞–Ω–∏–µ —Å–ø–∏—Å–∫–∞ whitelist –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ IP-–∞–¥—Ä–µ—Å–æ–≤</h2>
  <pre><code>sudo ipset create whitelist hash:ip

# –î–æ–±–∞–≤—å—Ç–µ –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ IP
sudo ipset add whitelist 192.168.1.100
sudo ipset add whitelist 203.0.113.55
sudo ipset add whitelist 1.2.3.4

# –ü—Ä–æ–≤–µ—Ä–∫–∞:
sudo ipset list whitelist</code></pre>

  <h2>3. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ iptables –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ whitelist</h2>
  <pre><code>sudo iptables -I INPUT -p tcp --dport 2220 -m set ! --match-set whitelist src -j DROP</code></pre>

  <div class="note">
    –≠—Ç–æ –ø—Ä–∞–≤–∏–ª–æ –±–ª–æ–∫–∏—Ä—É–µ—Ç –≤—Å–µ IP, –∫–æ—Ç–æ—Ä—ã—Ö <strong>–Ω–µ—Ç</strong> –≤ whitelist, –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ø–æ—Ä—Ç—É <strong>2220</strong>.
  </div>

  <h2>4. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ ipset –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª</h2>
  <pre><code>sudo ipset save > /etc/ipset.conf</code></pre>

  <h2>5. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∏ —á–µ—Ä–µ–∑ systemd</h2>
  <p>–°–æ–∑–¥–∞—ë–º systemd unit:</p>
  <pre><code>sudo nano /etc/systemd/system/ipset-restore.service</code></pre>

  <p>–í—Å—Ç–∞–≤—å—Ç–µ —Å–ª–µ–¥—É—é—â–µ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ:</p>
  <pre><code>[Unit]
Description=Restore ipset rules
Before=iptables.service
After=network.target

[Service]
Type=oneshot
ExecStart=/sbin/ipset restore &lt; /etc/ipset.conf
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target</code></pre>

  <p>–°–æ—Ö—Ä–∞–Ω—è–µ–º –∏ –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º —Å–µ—Ä–≤–∏—Å:</p>
  <pre><code>sudo systemctl daemon-reexec
sudo systemctl enable ipset-restore</code></pre>

  <h2>6. –°–æ—Ö—Ä–∞–Ω—è–µ–º iptables</h2>
  <pre><code>sudo netfilter-persistent save</code></pre>

  <h2>7. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞</h2>
  <pre><code>sudo reboot

# –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏:
sudo ipset list whitelist
sudo iptables -L -n -v --line-numbers</code></pre>

  <hr>
  <p><strong>–ì–æ—Ç–æ–≤–æ!</strong> –¢–µ–ø–µ—Ä—å —Å–µ—Ä–≤–µ—Ä –∑–∞—â–∏—â—ë–Ω: SSH –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ —Å —É–∫–∞–∑–∞–Ω–Ω—ã—Ö IP, –∏ –≤—Å—ë –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ.</p>

</body>
</html>
